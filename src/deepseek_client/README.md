DeepSeek Client - AI Integration Module

–ú–æ–¥—É–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –ø—Ä–æ–±–µ–∂–µ–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Yandex Vision OCR –∏ YandexGPT –∞–≥–µ–Ω—Ç–∞. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å Telegram –±–æ—Ç–æ–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.

üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

TEXT
src/deepseek_client/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ .env                                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è AI —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ extract_with_yandexgpt_agent_fixed.py # –û—Å–Ω–æ–≤–Ω–æ–π AI –º–æ–¥—É–ª—å
‚îî‚îÄ‚îÄ running_analysis_agent_result.json    # –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞

üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

AI –∞–Ω–∞–ª–∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤:
- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ Yandex Vision OCR
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ YandexGPT –∞–≥–µ–Ω—Ç–∞
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç—ã –ø—Ä–æ–±–µ–∂–∫–∏ (–Ω–µ —Ä–∞–Ω–µ–µ 25.11.2025)
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç XX.XX –∫–º
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –±–µ–≥–∞: Strava, Nike Run Club, Runkeeper –∏ –¥—Ä—É–≥–∏–µ
- –§–æ—Ä–º–∞—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: JPEG, PNG, WebP
- –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö: –¥–∞—Ç—ã, –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏, –≤—Ä–µ–º—è, –∫–∞–ª–æ—Ä–∏–∏

üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –≤ –ø–∞–ø–∫–µ deepseek_client:

ENV
# Yandex Cloud API Keys
YANDEX_VISION_API_KEY=your_vision_api_key_here
YANDEX_GPT_API_KEY=your_gpt_api_key_here
YANDEX_AGENT_ID=fvtbn62k72jiet7vpiej

2. –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
PYTHON
from deepseek_client.extract_with_yandexgpt_agent_fixed import extract_data_for_user

# –ê–Ω–∞–ª–∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
running_data = extract_data_for_user("path/to/screenshot.jpg")

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# {
#   'agent_response': {
#     'date': '08.11.2025',
#     'distance': '5.25 –∫–º'
#   },
#   'full_text': '—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç...'
# }

3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–æ—Ç–æ–º
PYTHON
# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö —ç—Ç–∞–ø–æ–≤ –∫–≤–µ—Å—Ç–∞
from deepseek_client.extract_with_yandexgpt_agent_fixed import extract_data_for_user

async def analyze_user_image(image_path: str):
    running_data = extract_data_for_user(image_path)
    
    if running_data and running_data.get('agent_response'):
        date = running_data['agent_response']['date']
        distance = running_data['agent_response']['distance']
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        await save_running_data_to_db(user_id, date, distance, running_data)
        return True
    
    return False

üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞:
TEXT
1. üì∏ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   ‚Üì
2. üîç Yandex Vision OCR
   ‚Üì
3. üìñ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
   ‚Üì
4. ü§ñ YandexGPT –∞–≥–µ–Ω—Ç
   ‚Üì
5. üìä –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   ‚Üì
6. üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î

–ö–ª–∞—Å—Å RunningDataExtractorWithAgent:
PYTHON
class RunningDataExtractorWithAgent:
    def __init__(self, vision_api_key, gpt_api_key, agent_id)
    def prepare_image(self, image_path) -> tuple
    def analyze_image_with_vision(self, image_path) -> dict
    def extract_full_text(self, response_data) -> str
    def analyze_with_gpt_agent(self, text) -> dict
    def parse_agent_response(self, response_text) -> dict
    def extract_running_data(self, image_path) -> dict
–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:
PYTHON
def extract_data_for_user(image_path: str) -> dict

üìä –§–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö
–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –ª—é–±—ã–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –±–µ–≥–∞
–¢–µ–∫—Å—Ç: —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π OCR —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –¥–∞—Ç
–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
JSON
{
  "agent_response": {
    "date": "08.11.2025",
    "distance": "5.25 –∫–º"
  },
  "full_text": "Strava\n8 –Ω–æ—è–±. 2025 –≥.\n5.25 –∫–º\n28:15\n..."
}
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç:
08.11.2025 (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π)
8 –Ω–æ—è–±. 2025 ‚Üí –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ 08.11.2025
November 8, 2025 ‚Üí –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ 08.11.2025
–õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π

üîê –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
Yandex Vision OCR:
Endpoint: https://ocr.api.cloud.yandex.net/ocr/v1
–ú–µ—Ç–æ–¥: recognizeText
–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —è–∑—ã–∫–æ–≤: –≤—Å–µ (["*"])
–¢–∞–π–º–∞—É—Ç: 30 —Å–µ–∫—É–Ω–¥
YandexGPT –∞–≥–µ–Ω—Ç:
Agent ID: **********
–ú–æ–¥–µ–ª—å: gpt://************/yandexgpt/rc
–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: 0.3 (–Ω–∏–∑–∫–∞—è –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
Max Tokens: 6000
–ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–≥–µ–Ω—Ç–∞:
TEXT
–≠—Ç–æ —Ç–µ–∫—Å—Ç –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –±–µ–≥–∞. –ò–∑–≤–ª–µ–∫–∏ –¥–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
1. date (–¥–∞—Ç–∞ –ø—Ä–æ–±–µ–∂–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ dd.mm.yyyy)
2. distance (–¥–∏—Å—Ç–∞–Ω—Ü–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ XX.XX –∫–º)

–í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –¥–∞—Ç—É —Ç–∏–ø–∞ "8 –Ω–æ—è–±." - –ø—Ä–µ–æ–±—Ä–∞–∑—É–π –≤ "08.11.2025"
–ï—Å–ª–∏ –≥–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω - –∏—Å–ø–æ–ª—å–∑—É–π 2025 –≥–æ–¥.
üõ†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏:
‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø–æ–∏—Å–∫–∞

–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
PYTHON
print(f"‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —ç–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä —Å agent_id: {self.agent_id}")
print(f"üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {os.path.basename(image_path)}")
print(f"üéØ –ê–ù–ê–õ–ò–ó –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø: {image_path}")
print(f"‚úÖ –ê–≥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª –¥–∞–Ω–Ω—ã–µ")

üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
–°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–æ –∫–∞—á–µ—Å—Ç–≤–∞ 90%
–¢–∞–π–º–∞—É—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ 30 —Å–µ–∫—É–Ω–¥
–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ JSON —Ñ–∞–π–ª—ã
–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –¥–æ 20MB
–ß–∞—Å—Ç–æ—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤: –ª–∏–º–∏—Ç—ã Yandex Cloud
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏: –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —Ä—É—Å—Å–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π

üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π

–° –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:
PYTHON
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü—É verification
INSERT INTO verification (user_id, distance, run_date, answer_check)
VALUES (?, ?, ?, ?)
–° –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ —ç—Ç–∞–ø–æ–≤:
PYTHON
# –í stage_1.py, stage_2.py, stage_3.py
from deepseek_client.extract_with_yandexgpt_agent_fixed import extract_data_for_user

async def analyze_user_image_and_save_results(telegram_id, user_id, image_path, message, state):
    running_data = extract_data_for_user(image_path)
    # –î–∞–ª—å–Ω–µ–π—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞...


–° –º–µ–¥–∏–∞ —Ñ–∞–π–ª–∞–º–∏:
PYTHON
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫
stage_folder = "media/stage_1"
os.makedirs(stage_folder, exist_ok=True)

üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫:
BASH
cd src/deepseek_client
python extract_with_yandexgpt_agent_fixed.py
–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
TEXT
‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —ç–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä —Å agent_id: fvtbn62k72jiet7vpiej
üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: screenshot.jpg
üéØ –ê–ù–ê–õ–ò–ó –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø: ../media/stage_1/screenshot.jpg
‚úÖ –ê–≥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª –¥–∞–Ω–Ω—ã–µ
üìä –î–ê–ù–ù–´–ï –û–¢ GPT –ê–ì–ï–ù–¢–ê:
üìÖ –î–∞—Ç–∞ –ø—Ä–æ–±–µ–∂–∫–∏: 08.11.2025
üìè –î–∏—Å—Ç–∞–Ω—Ü–∏—è: 5.25 –∫–º
–§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
running_analysis_agent_result.json - –ø–æ–ª–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
–õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
PYTHON
# requirements.txt
requests>=2.31.0
pillow>=8.0.0
python-dotenv>=1.0.0

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
YANDEX_VISION_API_KEY - –∫–ª—é—á –¥–ª—è Vision OCR
YANDEX_GPT_API_KEY - –∫–ª—é—á –¥–ª—è GPT –∞–≥–µ–Ω—Ç–∞
YANDEX_AGENT_ID - ID –≤–∞—à–µ–≥–æ –∞–≥–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:
–ß—Ç–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –ø–∞–ø–∫–∏ media/
–ó–∞–ø–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ JSON —Ñ–∞–π–ª—ã
–°–µ—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø –∫ Yandex Cloud API


–°—Ç–∞—Ç—É—Å –º–æ–¥—É–ª—è: üü¢ –ê–∫—Ç–∏–≤–Ω—ã–π
–¢–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ~95%
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–æ—Ç–æ–º: ‚úÖ –ü–æ–ª–Ω–∞—è
–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤: ‚úÖ –®–∏—Ä–æ–∫–∞—è