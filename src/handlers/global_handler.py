#!/usr/bin/env python3
# src/handlers/global_handler.py
import logging
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from database import db

logger = logging.getLogger('bot')

async def is_stage_completed(telegram_id: int, stage: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–≤–µ—Ä—à–µ–Ω –ª–∏ —ç—Ç–∞–ø –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    try:
        return db.is_stage_completed(telegram_id, stage)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —ç—Ç–∞–ø–∞ {stage}: {e}")
        return False

async def handle_global_unknown_messages(message: Message, state: FSMContext):
    """–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    telegram_id = message.from_user.id
    
    # ‚úÖ –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    current_state = await state.get_state()
    logger.info(f"üîç –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
    logger.info(f"üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: {current_state}")
    
    # ‚úÖ –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π —ç—Ç–∞–ø–æ–≤
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —ç—Ç–∞–ø–æ–≤
    if current_state and any(f"stage_{i}" in str(current_state) for i in range(1, 6)):
        logger.info(f"üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {telegram_id} –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —ç—Ç–∞–ø–∞ ({current_state}) - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É")
        return False  # –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ, –ø—É—Å—Ç—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ —ç—Ç–∞–ø–æ–≤
    
    # ‚úÖ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —ç—Ç–∞–ø–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ—Å—Ç—å —ç—Ç–∞–ø–æ–≤
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —ç—Ç–∞–ø—ã –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å–Ω–∞—á–∞–ª–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ)
        # –≠—Ç–æ –Ω—É–∂–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≤–µ—Ä—à–∏–ª —ç—Ç–∞–ø 4, 
        # –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∏–ª –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —ç—Ç–∞–ø—ã
        
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —ç—Ç–∞–ø 4
        stage_4_completed = await is_stage_completed(telegram_id, 4)
        if stage_4_completed:
            logger.info(f"üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {telegram_id} –∑–∞–≤–µ—Ä—à–∏–ª —ç—Ç–∞–ø 4 - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
            await message.answer(
                "ü§î *–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é, –æ —á–µ–º –í—ã –≥–æ–≤–æ—Ä–∏—Ç–µ.*\n\n"
                "üëã –î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∑–∞–±–µ–≥–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞.\n"
                "–î–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /menu.",
                parse_mode="Markdown"
            )
            return True
        
        # –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º —ç—Ç–∞–ø 3
        stage_3_completed = await is_stage_completed(telegram_id, 3)
        if stage_3_completed:
            logger.info(f"üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {telegram_id} –∑–∞–≤–µ—Ä—à–∏–ª —ç—Ç–∞–ø 3 - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
            await message.answer(
                "ü§î *–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é, –æ —á–µ–º –í—ã –≥–æ–≤–æ—Ä–∏—Ç–µ.*\n\n"
                "üëã –î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∑–∞–±–µ–≥–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞.\n"
                "–î–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /menu.",
                parse_mode="Markdown"
            )
            return True
        
        # –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º —ç—Ç–∞–ø 2
        stage_2_completed = await is_stage_completed(telegram_id, 2)
        if stage_2_completed:
            logger.info(f"üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {telegram_id} –∑–∞–≤–µ—Ä—à–∏–ª —ç—Ç–∞–ø 2 - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
            await message.answer(
                "ü§î *–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é, –æ —á–µ–º –í—ã –≥–æ–≤–æ—Ä–∏—Ç–µ.*\n\n"
                "üëã –î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∑–∞–±–µ–≥–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞.\n"
                "–î–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /menu.",
                parse_mode="Markdown"
            )
            return True
        
        # –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º —ç—Ç–∞–ø 1
        stage_1_completed = await is_stage_completed(telegram_id, 1)
        if stage_1_completed:
            logger.info(f"üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {telegram_id} –∑–∞–≤–µ—Ä—à–∏–ª —ç—Ç–∞–ø 1 - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
            await message.answer(
                "ü§î *–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é, –æ —á–µ–º –í—ã –≥–æ–≤–æ—Ä–∏—Ç–µ.*\n\n"
                "üëã –î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∑–∞–±–µ–≥–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞.\n"
                "–î–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /menu.",
                parse_mode="Markdown"
            )
            return True
            
        # –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω —ç—Ç–∞–ø –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        # –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
        logger.info(f"üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {telegram_id} –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª —ç—Ç–∞–ø—ã - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É")
        
    except Exception as db_error:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ—Å—Ç–∏ —ç—Ç–∞–ø–∞: {db_error}")
    
    return False  # –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ


def setup_global_handler(dp):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞"""
    from aiogram import F
    
    # ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ü–û–°–õ–ï –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    dp.message.register(
        handle_global_unknown_messages,
        F.text & ~F.text.startswith("/")  # –í—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–µ –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å "/"
    )
    
    logger.info("‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
