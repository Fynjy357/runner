Utils Module - ะฃัะธะปะธัั ะธ ะฒัะฟะพะผะพะณะฐัะตะปัะฝัะต ะผะพะดัะปะธ

ะะพะดัะปั ัะพะดะตัะถะธั ะฒัะฟะพะผะพะณะฐัะตะปัะฝัะต ััะฝะบัะธะธ, ััะธะปะธัั ะธ ะธะฝัะตะณัะฐัะธะธ ะดะปั ัะฐะฑะพัั Telegram ะฑะพัะฐ, ะฒะบะปััะฐั ัะฟัะฐะฒะปะตะฝะธะต ัะตััะธัะผะธ, ะปะพะณะธัะพะฒะฐะฝะธะต, ัะบัะฟะพัั ะดะฐะฝะฝัั ะธ ะพะฑัะฐะฑะพัะบั ัะฐะนะปะพะฒ.

๐ ะกัััะบัััะฐ ะผะพะดัะปั

TEXT
src/utils/
โโโ __init__.py
โโโ logger.py                    # ะะฐัััะพะนะบะฐ ะปะพะณะธัะพะฒะฐะฝะธั
โโโ shutdown_manager.py          # Graceful shutdown
โโโ config.py                   # ะะพะฝัะธะณััะฐัะธั ะฟัะธะปะพะถะตะฝะธั
โโโ rr_export_bot_friendly.py   # ะญะบัะฟะพัั ะธะท RussiaRunning
โโโ database_processor.py       # ะะฑัะฐะฑะพัะบะฐ Excel ะฒ ะะ
โโโ logs/                       # ะะฐะฟะบะฐ ั ะปะพะณะฐะผะธ
    โโโ bot.log

๐ง ะัะฝะพะฒะฝัะต ััะธะปะธัั
ะะพะณะธัะพะฒะฐะฝะธะต (logger.py)
PYTHON
from utils.logger import setup_logging

logger = setup_logging()
logger.info("ะกะพะพะฑัะตะฝะธะต ะดะปั ะปะพะณะฐ")
logger.error("ะัะธะฑะบะฐ")

ะัะพะฑะตะฝะฝะพััะธ:
ะะฒะพะนะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต - ะบะพะฝัะพะปั + ัะฐะนะป
UTF-8 ะบะพะดะธัะพะฒะบะฐ ะดะปั ััััะบะพะณะพ ัะตะบััะฐ
ะกัััะบัััะธัะพะฒะฐะฝะฝัะน ัะพัะผะฐั ั ะฒัะตะผะตะฝะฝัะผะธ ะผะตัะบะฐะผะธ
ะะฒัะพะผะฐัะธัะตัะบะพะต ัะพะทะดะฐะฝะธะต ะฟะฐะฟะบะธ logs

Graceful Shutdown (shutdown_manager.py)
PYTHON
from utils.shutdown_manager import ShutdownManager

shutdown_manager = ShutdownManager(bot, dp, logger)
shutdown_manager.setup_signal_handlers()
ะคัะฝะบัะธะพะฝะฐะปัะฝะพััั:

ะะฑัะฐะฑะพัะบะฐ SIGINT/SIGTERM ัะธะณะฝะฐะปะพะฒ
ะะพััะตะบัะฝะพะต ะทะฐะฒะตััะตะฝะธะต polling ะธ ัะตััะธะน
ะะฐัะธัะฐ ะพั ะฟะพะฒัะพัะฝะพะณะพ ะฒัะทะพะฒะฐ shutdown
ะะพะณะธัะพะฒะฐะฝะธะต ะฟัะพัะตััะฐ ะทะฐะฒะตััะตะฝะธั

ะะพะฝัะธะณััะฐัะธั (config.py)
PYTHON
from utils.config import Config

Config.validate()  # ะัะพะฒะตัะบะฐ ะพะฑัะทะฐัะตะปัะฝัั ะฟะตัะตะผะตะฝะฝัั
token = Config.BOT_TOKEN
db_path = Config.DATABASE_PATH


ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:

BOT_TOKEN - ัะพะบะตะฝ Telegram ะฑะพัะฐ
DATABASE_PATH - ะฟััั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั
๐ ะะฝัะตะณัะฐัะธั ั RussiaRunning
ะญะบัะฟะพััะตั (rr_export_bot_friendly.py)
PYTHON
from utils.rr_export_bot_friendly import rr_exporter

# ะัะพะฒะตัะบะฐ ัะตััะธะธ
is_authenticated, message = rr_exporter.ensure_authenticated()

# ะญะบัะฟะพัั ััะฐััะฝะธะบะพะฒ
filename = rr_exporter.export_participants_excel(otp_code)
ะะปะฐัั BotFriendlyRussiaRunningExporter:

ะััะตะฝัะธัะธะบะฐัะธั:
ะะฐะณััะทะบะฐ ัะตััะธะธ ะธะท ัะฐะนะปะฐ rr_session.json
ะะฒัะพะผะฐัะธัะตัะบะพะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ะฟัะธ ะธััะตัะตะฝะธะธ
ะะพะดะดะตัะถะบะฐ 2FA ัะตัะตะท Google Authenticator
ะะฐัะธัะฐ ะพั ะฑะปะพะบะธัะพะฒะบะธ ะฟัะธ ะพัะธะฑะบะฐั ะฟะฐัะพะปั
ะะตัะพะดั:
PYTHON
def ensure_authenticated() -> tuple[bool, str]
def complete_2fa_auth(otp_code: str) -> bool
def export_participants_excel(otp_code: str, use_fixed_name=True) -> str


ะะพะณะธะบะฐ ัะฐะฑะพัั:
ะัะพะฒะตัะบะฐ ัััะตััะฒัััะตะน ัะตััะธะธ
ะะพัััะฐะฝะพะฒะปะตะฝะธะต ัะตัะตะท API ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ
ะะฐะฟัะพั 2FA ะบะพะดะฐ ะตัะปะธ ััะตะฑัะตััั
ะญะบัะฟะพัั ะดะฐะฝะฝัั ะฒ Excel ัะพัะผะฐั
ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั


๐ ะะฑัะฐะฑะพัะบะฐ ะดะฐะฝะฝัั (database_processor.py)
ะัะฝะพะฒะฝัะต ััะฝะบัะธะธ:
process_participants_export()
PYTHON
from utils.database_processor import process_participants_export

success = process_participants_export()
ะัะพัะตัั ะพะฑัะฐะฑะพัะบะธ:

ะงัะตะฝะธะต Excel ัะฐะนะปะฐ participants_export_current.xls
ะะฐะปะธะดะฐัะธั ััััะบัััั ัะฐะฑะปะธั ะฑะฐะทั ะดะฐะฝะฝัั
ะัะตะพะฑัะฐะทะพะฒะฐะฝะธะต ะดะธััะฐะฝัะธะน ะฒ stage_id
ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒัั ะทะฐะฟะธัะตะน ะฒ manual_upload
ะัะพะฟััะบ ะดัะฑะปะธะบะฐัะพะฒ ะธ ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
fix_table_structure()
PYTHON
fix_table_structure('runners.db')

ะัะฟัะฐะฒะปัะตั ะฟัะพะฑะปะตะผั:

ะฃะฝะธะบะฐะปัะฝัะต ะธะฝะดะตะบัั ะผะตัะฐััะธะต ะธะผะฟะพััั
ะกัััะบัััั ัะฐะฑะปะธั ะดะปั ัะพะฒะผะตััะธะผะพััะธ
ะกะพะทะดะฐะตั ะฟัะฐะฒะธะปัะฝัะต ะธะฝะดะตะบัั
update_stages_table()
PYTHON
update_stages_table('runners.db')
ะะฑะฝะพะฒะปัะตั ััะฐะฟั:

Stage 1: "ะะะะะ 1. ยซะัะตะดะฐัะตะปัััะฒะพ ะฒ ะฆะตะฝััะฐะปัะฝะพะผ ััะฐะฑะตยป"
Stage 2: "ะะะะะ 2. ยซะัะพะฒะฐะป ะพะฟะตัะฐัะธะธยป"
Stage 3: "ะะะะะ 3. ยซะะฑัะฐัะฝัะน ะพัััะตัยป"
Stage 4: "ะะะะะ 4. ยซะะพัะปะตะดะฝะธะน ัะตะนัยป"
Stage 5: "ะะฐะบะตั ะฝะฐ 4 ััะฐะฟะฐ"


๐๏ธ ะขะตัะฝะธัะตัะบะธะต ะพัะพะฑะตะฝะฝะพััะธ
ะะฑัะฐะฑะพัะบะฐ Excel ัะฐะนะปะพะฒ:
ะะพะดะดะตัะถะบะฐ ัะพัะผะฐัะพะฒ:
.xls ัะตัะตะท ะดะฒะธะถะพะบ xlrd
.xlsx ัะตัะตะท ะดะฒะธะถะพะบ openpyxl
ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฟัะตะดะตะปะตะฝะธะต ัะพัะผะฐัะฐ
ะะฐะฟะฟะธะฝะณ ะดะธััะฐะฝัะธะน:
PYTHON
distance_mapping = {
    'ะะะะะ 1. ยซะัะตะดะฐัะตะปัััะฒะพ ะฒ ะฆะตะฝััะฐะปัะฝะพะผ ััะฐะฑะตยป': 1,
    'ะะะะะ 2. ยซะัะพะฒะฐะป ะพะฟะตัะฐัะธะธยป': 2,
    # ... ะพััะฐะปัะฝัะต ััะฐะฟั
}


ะะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั:
ะัะพะฒะตัะบะฐ ะพะฑัะทะฐัะตะปัะฝัั ะฟะพะปะตะน (ะคะะ, email, ัะตะปะตัะพะฝ)
ะัะธััะบะฐ ัะตะปะตัะพะฝะพะฒ ะพั ะฝะตัะธััะพะฒัั ัะธะผะฒะพะปะพะฒ
ะะพะธัะบ ะดัะฑะปะธะบะฐัะพะฒ ะฟะตัะตะด ะฒััะฐะฒะบะพะน
ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ั ะดะตัะฐะปัะฝัะผ ะปะพะณะธัะพะฒะฐะฝะธะตะผ
ะฃะฟัะฐะฒะปะตะฝะธะต ัะตััะธัะผะธ:
ะคะพัะผะฐั ัะตััะธะธ:
JSON
{
  "cookies": {...},
  "headers": {...},
  "username": "user@example.com",
  "timestamp": "2024-12-01T10:30:00",
  "authenticated": true,
  "two_factor_required": false
}
ะะพัััะฐะฝะพะฒะปะตะฝะธะต ัะตััะธะธ:
ะัะพะฒะตัะบะฐ ะฒะฐะปะธะดะฝะพััะธ ัะตัะตะท ัะตััะพะฒัะน ะทะฐะฟัะพั
ะะพัััะฐะฝะพะฒะปะตะฝะธะต cookies ะธ ะทะฐะณะพะปะพะฒะบะพะฒ
ะะฑะฝะพะฒะปะตะฝะธะต timestamp ะฟัะธ ััะฟะตัะฝะพะน ะฟัะพะฒะตัะบะต


๐ ะะตะทะพะฟะฐัะฝะพััั
ะะฐัะธัะฐ ััะตัะฝัั ะดะฐะฝะฝัั:
ะฅัะฐะฝะตะฝะธะต ะฒ .env ัะฐะนะปะต
ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฟะฐัะพะปะตะน ะฟัะธะปะพะถะตะฝะธะน
ะจะธััะพะฒะฐะฝะธะต ัะตััะธะน ะฟัะธ ัะพััะฐะฝะตะฝะธะธ
ะะณัะฐะฝะธัะตะฝะธะต ะดะพัััะฟะฐ ะบ ัะฐะนะปะฐะผ ัะตััะธะน

ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ:

Graceful degradation ะฟัะธ ะฟัะพะฑะปะตะผะฐั ั API
ะะพะฒัะพัะฝัะต ะฟะพะฟััะบะธ ั ัะบัะฟะพะฝะตะฝัะธะฐะปัะฝะพะน ะทะฐะดะตัะถะบะพะน
ะะตัะฐะปัะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ะดะปั ะดะธะฐะณะฝะพััะธะบะธ
ะฃะฒะตะดะพะผะปะตะฝะธั ะฐะดะผะธะฝะธัััะฐัะพัั ะพ ะบัะธัะธัะตัะบะธั ะพัะธะฑะบะฐั

๐ ะะพะฝะธัะพัะธะฝะณ
ะกัะฐัะธััะธะบะฐ ะพะฑัะฐะฑะพัะบะธ:
PYTHON
# ะะพัะปะต ะพะฑัะฐะฑะพัะบะธ Excel
print(f"โ ะะพะฑะฐะฒะปะตะฝะพ ะฝะพะฒัั ะทะฐะฟะธัะตะน: {new_count}")
print(f"โญ๏ธ ะัะพะฟััะตะฝะพ ะดัะฑะปะธะบะฐัะพะฒ: {skipped_count}") 
print(f"โ ะัะธะฑะพะบ ะพะฑัะฐะฑะพัะบะธ: {error_count}")
ะะพะณะธ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ:
ะัะตะผั ะฒัะฟะพะปะฝะตะฝะธั ะพะฟะตัะฐัะธะน
ะะพะปะธัะตััะฒะพ ะพะฑัะฐะฑะพัะฐะฝะฝัั ะทะฐะฟะธัะตะน
ะกัะฐัััั API ะทะฐะฟัะพัะพะฒ
ะะฐะทะผะตัั ัะฐะนะปะพะฒ ะธ ะฑะฐะท ะดะฐะฝะฝัั
๐ ะัะฟะพะปัะทะพะฒะฐะฝะธะต
ะะฝัะตะณัะฐัะธั ั ะฑะพัะพะผ:
PYTHON
# ะ ะพัะฝะพะฒะฝะพะผ ัะฐะนะปะต ะฑะพัะฐ
from utils.logger import setup_logging
from utils.shutdown_manager import ShutdownManager
from utils.config import Config

# ะะฐัััะพะนะบะฐ
logger = setup_logging()
Config.validate()

# Graceful shutdown
shutdown_manager = ShutdownManager(bot, dp, logger)
shutdown_manager.setup_signal_handlers()
ะะพะผะฐะฝะดั ัะบัะฟะพััะฐ:
PYTHON
# ะ ะพะฑัะฐะฑะพััะธะบะฐั ะบะพะผะฐะฝะด
from utils.rr_export_bot_friendly import rr_exporter

async def export_command(message):
    filename = rr_exporter.export_participants_excel(otp_code)
    if filename:
        await message.answer(f"โ ะญะบัะฟะพัั ะทะฐะฒะตััะตะฝ: {filename}")
ะะฒัะพะผะฐัะธัะตัะบะฐั ะพะฑัะฐะฑะพัะบะฐ:
PYTHON
# ะะพ ัะฐัะฟะธัะฐะฝะธั ะธะปะธ ััะธะณะณะตัั
from utils.database_processor import process_participants_export

async def scheduled_update():
    if process_participants_export():
        logger.info("ะะฐะทะฐ ะดะฐะฝะฝัั ััะฟะตัะฝะพ ะพะฑะฝะพะฒะปะตะฝะฐ")

๐ ะขัะตะฑะพะฒะฐะฝะธั
ะะฐะฒะธัะธะผะพััะธ:
PYTHON
# ะะปั RussiaRunning ะธะฝัะตะณัะฐัะธะธ
requests>=2.31.0
python-dotenv>=1.0.0

# ะะปั ะพะฑัะฐะฑะพัะบะธ Excel
pandas>=1.5.0
openpyxl>=3.0.0
xlrd>=2.0.0

# ะะปั ะฑะฐะทั ะดะฐะฝะฝัั
sqlite3 (ะฒัััะพะตะฝ)
ะกัััะบัััะฐ ัะฐะนะปะพะฒ:
TEXT
project/
โโโ .env
โโโ runners.db
โโโ rr_session.json
โโโ participants_export_current.xls
โโโ src/
    โโโ utils/
ะัะฐะฒะฐ ะดะพัััะฟะฐ:
ะงัะตะฝะธะต/ะทะฐะฟะธัั ะฑะฐะทั ะดะฐะฝะฝัั
ะกะตัะตะฒะพะน ะดะพัััะฟ ะบ RussiaRunning API
ะกะพะทะดะฐะฝะธะต ัะฐะนะปะพะฒ ะฒ ะบะพัะฝะต ะฟัะพะตะบัะฐ
ะะฐะฟะธัั ะปะพะณะพะฒ ะฒ ะฟะฐะฟะบั logs
ะกัะฐััั ะผะพะดัะปั: ๐ข ะะบัะธะฒะฝัะน
ะะฝัะตะณัะฐัะธั ั RussiaRunning: โ ะะพะปะฝะฐั
ะะฑัะฐะฑะพัะบะฐ ะดะฐะฝะฝัั: โ ะะฒัะพะผะฐัะธัะตัะบะฐั
ะะพะณะธัะพะฒะฐะฝะธะต: โ ะกัััะบัััะธัะพะฒะฐะฝะฝะพะต